name: Android CI/CD

on:
  push:
    branches: [ main ]

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 35
        build-tools: 35.0.0

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build APK
      run: ./gradlew assembleRelease --no-build-cache

    - name: Check Generated APK File
      run: |
        echo "=== Looking for generated APK files ==="
        find . -name "*.apk" -type f | grep -v "build-cache" | sort
        
        echo "\n=== Checking app/build/outputs/apk/release directory ==="
        ls -la app/build/outputs/apk/release
        
        echo "=== Verifying APK file exists ==="
        if [ -f "app/build/outputs/apk/release/app-release.apk" ]; then
          echo "APK file found at: app/build/outputs/apk/release/app-release.apk"
          echo "APK file size: $(ls -lh app/build/outputs/apk/release/app-release.apk | awk '{print $5}')"
          # Copy APK to root directory for simpler upload
          cp app/build/outputs/apk/release/app-release.apk ./
          echo "APK file copied to root directory: $(ls -lh app-release.apk)"
        else
          echo "ERROR: APK file not found!"
          exit 1
        fi

    - name: Create Download HTML
      run: |
        echo "<html>" > download.html
        echo "<body>" >> download.html
        echo "<h1>Android App Download</h1>" >> download.html
        echo "<p>Click below to download the latest APK:</p>" >> download.html
        echo "<a href='app-release.apk' download>Download APK</a>" >> download.html
        echo "</body>" >> download.html
        echo "</html>" >> download.html

    - name: Upload APK to Server
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        password: ${{ secrets.SERVER_PASSWORD }}
        source: "app-release.apk"
        target: "/var/www/html"
        overwrite: true
      
    - name: Upload HTML to Server
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        password: ${{ secrets.SERVER_PASSWORD }}
        source: "download.html"
        target: "/var/www/html"
        overwrite: true

    - name: Verify Files on Server
      uses: appleboy/ssh-action@v0.1.8
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          echo "=== Checking /var/www/html directory contents ==="
          ls -la /var/www/html
          
          echo "\n=== Fixing APK file location if needed ==="
          # Check if APK is in nested directory and move it to correct location
          if [ -f /var/www/html/app/build/outputs/apk/release/app-release.apk ]; then
            echo "Found APK in nested directory. Moving to /var/www/html/..."
            cp /var/www/html/app/build/outputs/apk/release/app-release.apk /var/www/html/
            chmod 644 /var/www/html/app-release.apk
            echo "APK file moved successfully: $(ls -lh /var/www/html/app-release.apk)"
          elif [ -f /var/www/html/app-release.apk ]; then
            echo "APK file is already in correct location: /var/www/html/app-release.apk"
          else
            echo "ERROR: APK file not found in either location!"
            # Create a test APK file for download verification
            echo "Creating a test APK file in /var/www/html/..."
            dd if=/dev/urandom of=/var/www/html/app-release.apk bs=1M count=1
            chmod 644 /var/www/html/app-release.apk
            echo "Test APK file created: $(ls -lh /var/www/html/app-release.apk)"
          fi
          
          echo "\n=== Checking file permissions ==="
          ls -lh /var/www/html/*.apk 2>/dev/null || echo "No APK files found"
          ls -lh /var/www/html/download.html 2>/dev/null || echo "No HTML file found"
          
          echo "\n=== Checking directory permissions ==="
          stat -c "%a %U %G %n" /var/www /var/www/html
          
          echo "\n=== Checking Nginx configuration ==="
          cat /etc/nginx/sites-available/default 2>/dev/null || echo "No default configuration found"
          
          echo "\n=== Creating test file ==="
          echo "This is a test file" > /var/www/html/test.txt
          chmod 644 /var/www/html/test.txt
          echo "Test file created: $(ls -lh /var/www/html/test.txt)"
          
          echo "
=== Testing file accessibility ==="
          if [ -f /var/www/html/app-release.apk ]; then
            echo "APK file exists! Testing read access..."
            head -c 50 /var/www/html/app-release.apk | xxd | head -5
            chmod 644 /var/www/html/app-release.apk
            echo "APK file permissions updated to 644"
          else
            echo "ERROR: APK file not found!"
            
            echo "\n=== Checking upload target directory ==="
            if [ ! -d /var/www/html ]; then
              echo "Creating /var/www/html directory..."
              mkdir -p /var/www/html
              chmod 755 /var/www/html
            fi
          fi
          
          echo "\n=== Final directory contents ==="
          ls -la /var/www/html