name: Android CI/CD

on:
  push:
    branches: [ main ]

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 35
        build-tools: 35.0.0

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build Release APK
      run: ./gradlew assembleRelease

    - name: Check APK file location
      run: find app/build -name "*.apk" | sort

    - name: Create Download HTML
      run: |
        echo "<html>" > download.html
        echo "<body>" >> download.html
        echo "<h1>Android App Download</h1>" >> download.html
        echo "<p>Click below to download the latest APK:</p>" >> download.html
        echo "<a href='app-release-unsigned.apk' download>Download APK</a>" >> download.html
        echo "</body>" >> download.html
        echo "</html>" >> download.html

    - name: Upload Files to Server
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        password: ${{ secrets.SERVER_PASSWORD }}
        source: "app/build/outputs/apk/release/app-release-unsigned.apk,download.html"
        target: "/var/www/html"
        overwrite: true

    - name: Verify Files on Server
      uses: appleboy/ssh-action@v0.1.8
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          echo "=== Checking /var/www/html directory contents ==="
          ls -la /var/www/html
          
          echo "\n=== Checking file permissions ==="
          ls -lh /var/www/html/*.apk 2>/dev/null || echo "No APK files found"
          ls -lh /var/www/html/download.html 2>/dev/null || echo "No HTML file found"
          
          echo "\n=== Checking directory permissions ==="
          stat -c "%a %U %G %n" /var/www /var/www/html
          
          echo "\n=== Checking Nginx configuration ==="
          cat /etc/nginx/sites-available/default 2>/dev/null || echo "No default configuration found"
          
          echo "\n=== Testing file accessibility ==="
          if [ -f /var/www/html/app-release-unsigned.apk ]; then
            echo "APK file exists! Testing read access..."
            head -c 50 /var/www/html/app-release-unsigned.apk | xxd | head -5
          else
            echo "ERROR: APK file not found!"
            
            echo "\n=== Checking upload target directory ==="
            if [ ! -d /var/www/html ]; then
              echo "Creating /var/www/html directory..."
              mkdir -p /var/www/html
              chmod 755 /var/www/html
            fi
          fi